<p>The Reach RPC Protocol (hereafter, "the protocol" or "it") is an instance of <a href="https://en.wikipedia.org/wiki/JSON">JSON</a>-based RPC protocol.</p>
<p>It should be transported over <a href="https://en.wikipedia.org/wiki/HTTPS">HTTPS</a> (i.e. HTTP over TLS).</p>
<p>
  Requests must include an <code>X-API-Key</code> header whose value is a shared secret between a server instance and an RPC client, referred to as the ${defn("API key")}.
  Typically this value comes from the environment variable <code>REACH_RPC_KEY</code> and is the <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encoding of 24 random bytes.
</p>
<p>Requests must use the <code>POST</code> HTTP method.</p>
<p>Requests specify the RPC method to be invoked via the HTTP request target.</p>
<p>
  Requests must include a <a href="https://en.wikipedia.org/wiki/JSON">JSON</a>-encoded array in their body.
  Requests should indicate this by setting the <code>Content-Type</code> header to <code>application/json; charset=utf-8</code>.
  This array is interpreted as the arguments to the RPC method.
</p>
<p>
  Responses must include a <a href="https://en.wikipedia.org/wiki/JSON">JSON</a>-encoded value in their body.
  Responses should indicate this by setting the <code>Content-Type</code> header to <code>application/json; charset=utf-8</code>.
</p>
<p>Responses may include ${defn("RPC handles")}, which are strings that represent intermediate resources held on the RPC server that cannot be serialized to JSON.</p>
<p>RPC methods are either synchronous value RPC methods or interactive RPC methods.</p>
<hr>
<p>
  ${defn("Synchronous value RPC methods")} consume arguments and produce a single result without further interaction with the client.
  The result is the body of the response.
</p>
<p>
  For example, <code>formatCurrency</code> is a synchronous value RPC method.
  A call to <code>formatCurrency("19283.1035819471", 4)</code> would be represented by the following HTTP session, with request lines indicated by <code>+</code> and response lines indicated by <code>-</code>:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1">+ POST /stdlib/formatCurrency HTTP/1.1</li><li value="2">+ X-API-Key: OpenSesame</li><li value="3">+ Content-Type: application/json; charset=utf-8</li><li value="4">+</li><li value="5">+ [ "19283.1035819471", 4 ]</li><li value="6"></li><li value="7">- HTTP/1.1 200 OK</li><li value="8">- Content-Type: application/json; charset=utf-8</li><li value="9">-</li><li value="10">- "19283.1035"</li></ol></pre>
<hr>
<p>${defn("Interactive RPC methods")} consume arguments, including a specification of interactive RPC callbacks, and produce an interactive RPC continuation.</p>
<p>An ${defn("interactive RPC callback")} is a key of a JSON object, bound to <code>true</code>, that indicates that the initiator of an interactive RPC method responds to requests for further data during the execution of this call.</p>
<p>An ${defn("interactive RPC continuation")} is a JSON object that matches either:</p>
<ul>
  <li><code>{t: "Done", ans}</code>, where <code>ans</code> is the final result of the original interactive RPC method.</li>
  <li><code>{t: "Kont", kid, m, args}</code>, where <code>kid</code> is an RPC handle, <code>m</code> is a string naming one of the interactive RPC callback methods, and <code>args</code> is an array of the arguments to that method.</li>
</ul>
<p>
  When a <code>Kont</code> value is produced, then the interactive RPC method is suspended until the <code>/kont</code> RPC method is invoked with the continuation RPC handle and the return value of the interactive RPC callback.
  The result of the <code>/kont</code> RPC method is another interactive RPC continuation.
</p>
<p>Clients may perform any RPC methods while an interactive RPC method is suspended.</p>
<p>The server may re-use the same interactive RPC continuation handle many times.</p>
<p>
  For example, the execution of a backend is an interactive RPC method.
  An example interaction might be represented by the following HTTP session, with request lines indicated by <code>+</code> and response lines indicated by <code>-</code>:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1">+ POST /backend/Alice HTTP/1.1</li><li value="2">+ X-API-Key: OpenSesame</li><li value="3">+ Content-Type: application/json; charset=utf-8</li><li value="4">+</li><li value="5">+ [ "Contract-42", { "price": 10 }, { "showX": true } ]</li><li value="6"></li><li value="7">- HTTP/1.1 200 OK</li><li value="8">- Content-Type: application/json; charset=utf-8</li><li value="9">-</li><li value="10">- { t: "Kont", kid: "Kont-A", m: "showX", args: [ "19283.1035819471" ] }</li><li value="11"></li><li value="12">+ POST /stdlib/formatCurrency HTTP/1.1</li><li value="13">+ X-API-Key: OpenSesame</li><li value="14">+ Content-Type: application/json; charset=utf-8</li><li value="15">+</li><li value="16">+ [ "19283.1035819471", 4 ]</li><li value="17"></li><li value="18">- HTTP/1.1 200 OK</li><li value="19">- Content-Type: application/json; charset=utf-8</li><li value="20">-</li><li value="21">- "19283.1035"</li><li value="22"></li><li value="23">+ POST /kont HTTP/1.1</li><li value="24">+ X-API-Key: OpenSesame</li><li value="25">+ Content-Type: application/json; charset=utf-8</li><li value="26">+</li><li value="27">+ [ "Kont-A", null ]</li><li value="28"></li><li value="29">- HTTP/1.1 200 OK</li><li value="30">- Content-Type: application/json; charset=utf-8</li><li value="31">-</li><li value="32">- { t: "Done", ans: null }</li></ol></pre>