<p>
  A Reach step occurs in the continuation of a deploy statement or commit statement.
  It represents the actions taken by each of the participants in an application.
</p>
<h2 id="statements">Statements</h2>
<p>
  Any statements valid for a <a href="##ref-programs-compute-stmts">computation</a> are valid for a step.
  However, some additional statements are allowed.
</p>
<h3 id="only-and-each"><code>only</code> and <code>each</code></h3>
<p>${ref((quote rsh), "only")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">pretzel</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">random</span><span style="color: #24292E">(); });</span></li></ol></pre>
<p>
  A local step statement is written <code>PART.only(() =&gt; BLOCK)</code>, where <code>PART</code> is a participant identifier and <code>BLOCK</code> is a block.
  Within <code>BLOCK</code>, <code>PART</code> is bound to the address of the participant.
  Any bindings defined within the block of a local step are available in the statement's tail as new local state.
  For example,
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="3"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">y</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li></ol></pre>
<p>is a valid program where <code>Alice</code>'s local state includes the private values <code>x</code> (bound to <code>3</code>) and <code>y</code> (bound to <code>4</code>). However, such bindings are <em>not</em> consensus state, so they are purely local state. For example,</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="3"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">y</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li></ol></pre>
<p>is an invalid program, because <code>Bob</code> does not know <code>x</code>.</p>
<p>
  The ${defn("interact shorthand")}, written <code>PART.interact.METHOD(EXPR_0, ..., EXPR_n)</code>, is available for calling an <code>interact</code> function
  from outside of an <code>only</code> block. Such functions must return <code>Null</code>; therefore, they are only useful
  if they produce side-effects, such as logging on the frontend. For example, the
  function <code>log</code> in the participant interact interface of <code>Alice</code> may be called via:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.interact.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(x);</span></li></ol></pre>
<hr>
<p>${ref((quote rsh), "each")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">each</span><span style="color: #24292E">([Alice, Bob], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">pretzel</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">random</span><span style="color: #24292E">(); });</span></li></ol></pre>
<p>
  An ${defn("each")} local step statement can be written as <code>each(PART_TUPLE () =&gt; BLOCK)</code>, where <code>PART_TUPLE</code> is a tuple of participants and <code>BLOCK</code> is a block.
  It is an abbreviation of many local step statements that could have been written with <code>only</code>.
</p>
<h3 id="pay-amounts">Pay Amounts</h3>
<p>A ${defn("pay amount")} is either:</p>
<ul>
  <li>An integer, denoting an amount of network tokens; or,</li>
  <li>A tuple of token amounts.</li>
</ul>
<p>A ${defn("token amount")} is either:</p>
<ul>
  <li>An integer, denoting an amount of network tokens; or,</li>
  <li>A tuple with two elements, where the first is an integer, denoting an amount of non-network tokens, and the second is <code>Token</code>, specifying a particular non-network token.</li>
</ul>
<p>For example, these are all pay amounts:</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #005CC5">0</span></li><li value="2"><span style="color: #005CC5">5</span></li><li value="3"><span style="color: #24292E">[ </span><span style="color: #005CC5">5</span><span style="color: #24292E"> ]</span></li><li value="4"><span style="color: #24292E">[ </span><span style="color: #005CC5">5</span><span style="color: #24292E">, [ </span><span style="color: #005CC5">2</span><span style="color: #24292E">, gil ] ]</span></li><li value="5"><span style="color: #24292E">[ [ </span><span style="color: #005CC5">2</span><span style="color: #24292E">, gil ], </span><span style="color: #005CC5">5</span><span style="color: #24292E"> ]</span></li><li value="6"><span style="color: #24292E">[ </span><span style="color: #005CC5">5</span><span style="color: #24292E">, [ </span><span style="color: #005CC5">2</span><span style="color: #24292E">, gil ], [ </span><span style="color: #005CC5">8</span><span style="color: #24292E">, zorkmids ] ]</span></li></ol></pre>
<p>
  It is invalid for a pay amount to specify an amount of tokens multiple times.
  For examples, these are invalid pay amounts:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">[ </span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">2</span><span style="color: #24292E"> ]</span></li><li value="2"><span style="color: #24292E">[ [</span><span style="color: #005CC5">2</span><span style="color: #24292E">, gil], [</span><span style="color: #005CC5">1</span><span style="color: #24292E">, gil] ]</span></li></ol></pre>
<p>
  The ordering of a pay amount is only significant when used within a fork statement or parallel reduce statement that specifies a <code>paySpec</code>.
  In this case, payments are expected to be a tuple where the first element is an integer pay amount, and the rest of the elements are token amount tuples. The ordering of the token amount elements should match the ordering in <code>paySpec</code>. For example,
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">.</span><span style="color: #6F42C1">paySpec</span><span style="color: #24292E">([tokA, tokB])</span></li></ol></pre>
<p>will indicate that <code>fork</code> payments should be of the format:</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">[ </span><span style="color: #005CC5">NETWORK_TOKEN_AMT</span><span style="color: #24292E">, [ amtA, tokA ], [ amtB, tokB ] ]</span></li></ol></pre>
<h3 id="publish-pay-when-and-timeout"><code>publish</code>, <code>pay</code>, <code>when</code>, and <code>timeout</code></h3>
<p>${ref((quote rsh), "publish")}${ref((quote rsh), "pay")}${ref((quote rsh), "when")}${ref((quote rsh), "timeout")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(wagerAmount)</span></li><li value="2"><span style="color: #24292E">     .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(wagerAmount)</span></li><li value="3"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E">       Bob.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="5"><span style="color: #24292E">       </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="6"><span style="color: #24292E">       </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">; });</span></li></ol></pre>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(wagerAmount)</span></li><li value="2"><span style="color: #24292E">     .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(wagerAmount)</span></li><li value="3"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">closeTo</span><span style="color: #24292E">(Bob, </span><span style="color: #005CC5">false</span><span style="color: #24292E">));</span></li></ol></pre>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(wagerAmount)</span></li><li value="2"><span style="color: #24292E">     .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(wagerAmount)</span></li><li value="3"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span></li></ol></pre>
<p>
  ::: note
  If you're unsure of what kind of consensus transfer to use, you may want to read the <a href="##guide-ctransfers">explanation of the differences</a> in the Guide.
  :::
</p>
<p>
  A consensus transfer is written <code>PART_EXPR.publish(ID_0, ..., ID_n).pay(PAY_EXPR).when(WHEN_EXPR).timeout(DELAY_EXPR, () =&gt; TIMEOUT_BLOCK)</code>,
  where <code>PART_EXPR</code> is an expression that evaluates to a participant or race expression,
  <code>ID_0</code> through <code>ID_n</code> are identifiers for <code>PART</code>'s public local state,
  <code>PAY_EXPR</code> is a public expression evaluating to a pay amount,
  <code>WHEN_EXPR</code> is a public expression evaluating to a boolean and determines if the consensus transfer takes place,
  <code>DELAY_EXPR</code> is a public expression that depends on only consensus state and evaluates to a time argument,
  <code>TIMEOUT_BLOCK</code> is a timeout block, which will be executed after the <code>DELAY_EXPR</code> time argument passes without <code>PART</code> executing this consensus transfer.
</p>
<p>
  All of the expressions within a consensus transfer are evaluated in a ${defn("pure")} context, which may not alter the state of the
  application.
  The <code>PAY_EXPR</code>, <code>WHEN_EXPR</code>, and <code>DELAY_EXPR</code> expressions must refer only to the consensus state, including the new data published via the <code>.publish</code> component.
</p>
<p>
  The continuation of a consensus transfer statement is a consensus step, which is finalized with a commit statement.
  The continuation of a timeout block is the same as the continuation of the function the timeout occurs within.
</p>
<p>
  ::: note
  See <a href="##guide-timeout">the guide section on non-participation</a> to understand when to use timeouts and how to use them most effectively.
  :::
</p>
<p>
  The <code>publish</code> component exclusive-or the <code>pay</code> component may be omitted, if either there is no publication or no transfer of network tokens to accompany this consensus transfer.
  The <code>when</code> component may always be omitted, in which case it is assumed to be <code>true</code>.
  <code>publish</code> or <code>pay</code> must occur first, after which components may occur in any order.
  For example, the following are all valid:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip);</span></li><li value="2"></li><li value="3"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount);</span></li><li value="4"></li><li value="5"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip);</span></li><li value="6"></li><li value="7"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip)</span></li><li value="8"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">closeTo</span><span style="color: #24292E">(Bob, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">()));</span></li><li value="9"></li><li value="10"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount)</span></li><li value="11"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="12"><span style="color: #24292E">       Bob.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="13"><span style="color: #24292E">       </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="14"><span style="color: #24292E">       </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="15"></li><li value="16"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(bid).</span><span style="color: #6F42C1">when</span><span style="color: #24292E">(wantsToBid);</span></li></ol></pre>
<p>
  The <code>timeout</code> component must be included if <code>when</code> is not statically <code>true</code>.
  This ensures that your clients will eventually complete the program.
  If a consensus transfer is a guaranteed race between non-class participants and a participant class that <em>may</em> attempt to transfer (i.e. <code>when</code> is not statically <code>false</code>), then a <code>timeout</code> may be explicitly omitted by writing <code>.timeout(false)</code>.
</p>
<p>
  <code>.throwTimeout</code> may be used in place of <code>.timeout</code>. It accepts a <code>DELAY_EXPR</code> and an <code>EXPR</code>, which will be thrown if a timeout should occur.
  If an <code>EXPR</code> is not provided, then <code>null</code> will be thrown.
  If a consensus transfer uses <code>.throwTimeout</code>, it must be within a try statement.
</p>
<p>If a consensus transfer specifies a single participant, which has not yet been fixed in the application and is not a participant class, then this statement does so; therefore, after it the <code>PART</code> may be used as an address.</p>
<p>If a consensus transfer specificies a single participant class, then all members of that class will attempt to perform the transfer, but only one will succeed.</p>
<p>
  A consensus transfer binds the identifiers <code>ID_0</code> through <code>ID_n</code> for all participants to the values included in the consensus transfer, overwriting any bindings that already exist for those identifiers.
  If an existing participant, not included in <code>PART_EXPR</code>, has previously bound one of these identifiers, then the program is not valid. In other words, the following program is not valid:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li><li value="3"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E">; });</span></li><li value="5"><span style="color: #24292E">Claire.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="6"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="7"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(x);</span></li><li value="8"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>
  because <code>Claire</code> is not included in the <code>race</code>.
  However, if we were to rename <code>Claire</code>'s <code>x</code> into <code>y</code>, then it would be valid, because although <code>Alice</code> and <code>Bob</code> both bind <code>x</code>, they participate in the <code>race</code>, so it is allowed.
  In the tail of this program, <code>x</code> is bound to either <code>1</code> or <code>2</code>, i.e., either <code>Alice</code> or <code>Bob</code>'s value is overwritten.
  This overwriting applies even if <code>Alice</code> wins and <code>Alice</code> is a participant class, i.e., the value of <code>x</code> in the tail is guaranteed to be the single value that was agreed upon in the consensus.
</p>
<h3 id="fork"><code>fork</code></h3>
<p>${ref((quote rsh), "fork")}${ref((quote rsh), "paySpec")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">fork</span><span style="color: #24292E">()</span></li><li value="2"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Alice, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="3"><span style="color: #24292E">  msg: </span><span style="color: #005CC5">19</span><span style="color: #24292E">,</span></li><li value="4"><span style="color: #24292E">  when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="5"><span style="color: #24292E">  ((</span><span style="color: #E36209">v</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> v),</span></li><li value="6"><span style="color: #24292E">  (</span><span style="color: #E36209">v</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="7"><span style="color: #24292E">    </span><span style="color: #005CC5">require</span><span style="color: #24292E">(v </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="8"><span style="color: #24292E">    </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="9"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="10"><span style="color: #24292E">    </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li><li value="11"><span style="color: #24292E">  })</span></li><li value="12"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Bob, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="13"><span style="color: #24292E">  when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="14"><span style="color: #24292E">  ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> wager),</span></li><li value="15"><span style="color: #24292E">  (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="16"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="17"></li><li value="18"><span style="color: #24292E">    Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showOpponent</span><span style="color: #24292E">(Bob));</span></li><li value="19"></li><li value="20"><span style="color: #24292E">    </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="21"><span style="color: #24292E">    </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="22"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="23"><span style="color: #24292E">    </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li><li value="24"><span style="color: #24292E">  })</span></li><li value="25"><span style="color: #24292E">.</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="26"><span style="color: #24292E">  </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="27"><span style="color: #24292E">  </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="28"><span style="color: #24292E">  </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="29"><span style="color: #24292E">  </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li></ol></pre>
<p>
  ::: note
  If you're unsure of what kind of consensus transfer to use, you may want to read the <a href="##guide-ctransfers">explanation of the differences</a> in the Guide.
  :::
</p>
<p>A ${defn("fork statement")} is written:</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">fork</span><span style="color: #24292E">()</span></li><li value="2"><span style="color: #24292E">.</span><span style="color: #6F42C1">paySpec</span><span style="color: #24292E">(</span><span style="color: #005CC5">TOKENS_EXPR</span><span style="color: #24292E">)</span></li><li value="3"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span><span style="color: #005CC5">PART_EXPR</span><span style="color: #24292E">,</span></li><li value="4"><span style="color: #24292E">  </span><span style="color: #005CC5">PUBLISH_EXPR</span><span style="color: #24292E">,</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="6"><span style="color: #24292E">  </span><span style="color: #005CC5">CONSENSUS_EXPR</span><span style="color: #24292E">)</span></li><li value="7"><span style="color: #24292E">.</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span></li><li value="8"><span style="color: #24292E">  </span><span style="color: #005CC5">TIMEOUT_BLOCK</span><span style="color: #24292E">);</span></li></ol></pre>
<p>
  where:
  <code>TOKENS_EXPR</code> is an expression that evaluates to a tuple of <code>Token</code>s.
  <code>PART_EXPR</code> is an expression that evaluates to a participant;
  <code>PUBLISH_EXPR</code> is a syntactic arrow expression that is evaluated in a local step for the specified participant and must evaluate to an object that may contain a <code>msg</code> field, which may be of any type, and a <code>when</code> field, which must be a boolean;
  <code>PAY_EXPR</code> is an expression that evaluates to a function parameterized over the <code>msg</code> value and returns a pay amount;
  <code>CONSENSUS_EXPR</code> is a syntactic arrow expression parameterized over the <code>msg</code> value which is evaluated in a consensus step; and,
  the <code>timeout</code> and <code>throwTimeout</code> parameter are as in an consensus transfer.
</p>
<p>If the <code>msg</code> field is absent from the object returned from <code>PUBLISH_EXPR</code>, then it is treated as if it were <code>null</code>.</p>
<p>If the <code>when</code> field is absent from the object returned from <code>PUBLISH_EXPR</code>, then it is treated as if it were <code>true</code>.</p>
<p>If the <code>PAY_EXPR</code> is absent, then it is treated as if it were <code>(_) =&gt; 0</code>.</p>
<p>The <code>TOKENS_EXPR</code> and <code>PAY_EXPR</code> have the same restrictions as the <code>.pay</code> component of a consensus transfer: i.e., they must be pure and can only refer to consensus state.</p>
<p>The <code>.case</code> component may be repeated many times.</p>
<p>
  The same participant may specify multiple cases. In this situation, the order of the cases is significant.
  That is, a subsequent case will only be evaluated if the prior case's <code>when</code> field is <code>false</code>.
</p>
<p>If the participant specified by <code>PART_EXPR</code> is not already fixed (in the sense of <code>Participant.set</code>), then if it wins the <code>race</code>, it is fixed, provided it is not a participant class.</p>
<h4 id="fork-intuition"><code>fork</code> intuition</h4>
<p>A fork statement is an abbreviation of a common <code>race</code> and <code>switch</code> pattern you could write yourself.</p>
<p>
  The idea is that each of the participants in the <code>case</code> components do an independent local step evaluation of a value they would like to <code>publish</code> and then all <code>race</code> to <code>publish</code> their value.
  The one that "wins" the <code>race</code> then determines not only the value (&amp; <code>pay</code> expression), but also what consensus step code runs to consume the value.
</p>
<p>The sample <code>fork</code> statement linked to the <code>fork</code> keyword is roughly equivalent to:</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6A737D">// We first define a Data instance so that each participant can publish a</span></li><li value="2"><span style="color: #6A737D">// different kind of value</span></li><li value="3"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ForkData</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Data</span><span style="color: #24292E">({Alice: UInt, Bob: Null});</span></li><li value="4"><span style="color: #6A737D">// Then we bind these values for each participant</span></li><li value="5"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="6"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_msg</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ForkData.</span><span style="color: #6F42C1">Alice</span><span style="color: #24292E">(</span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="7"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_when</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()); });</span></li><li value="8"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="9"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_msg</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ForkData.</span><span style="color: #6F42C1">Bob</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">);</span></li><li value="10"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_when</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()); });</span></li><li value="11"><span style="color: #6A737D">// They race</span></li><li value="12"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob)</span></li><li value="13"><span style="color: #24292E"> .</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(fork_msg)</span></li><li value="14"><span style="color: #24292E"> .</span><span style="color: #6F42C1">when</span><span style="color: #24292E">(fork_when)</span></li><li value="15"><span style="color: #24292E"> </span><span style="color: #6A737D">// The pay ammount depends on who is publishing</span></li><li value="16"><span style="color: #24292E"> .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(fork_msg.</span><span style="color: #6F42C1">match</span><span style="color: #24292E">( {</span></li><li value="17"><span style="color: #24292E">   Alice: (</span><span style="color: #E36209">v</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> v),</span></li><li value="18"><span style="color: #24292E">   Bob: ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> wager) } ))</span></li><li value="19"><span style="color: #24292E"> </span><span style="color: #6A737D">// The timeout is always the same</span></li><li value="20"><span style="color: #24292E"> .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="21"><span style="color: #24292E">   </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="22"><span style="color: #24292E">   </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="23"><span style="color: #24292E">   </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="24"><span style="color: #24292E">   </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="25"></li><li value="26"><span style="color: #24292E"> </span><span style="color: #6A737D">// We ensure that the correct participant published the correct kind of value</span></li><li value="27"><span style="color: #24292E"> </span><span style="color: #005CC5">require</span><span style="color: #24292E">(fork_msg.</span><span style="color: #6F42C1">match</span><span style="color: #24292E">( {</span></li><li value="28"><span style="color: #24292E">   </span><span style="color: #6A737D">// Alice had previously published</span></li><li value="29"><span style="color: #24292E">   Alice: (</span><span style="color: #E36209">v</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E"> </span><span style="color: #D73A49">==</span><span style="color: #24292E"> Alice),</span></li><li value="30"><span style="color: #24292E">   </span><span style="color: #6A737D">// But Bob had not.</span></li><li value="31"><span style="color: #24292E">   Bob: ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">) } ));</span></li><li value="32"></li><li value="33"><span style="color: #24292E"> </span><span style="color: #6A737D">// Then we select the appropriate body to run</span></li><li value="34"><span style="color: #24292E"> </span><span style="color: #D73A49">switch</span><span style="color: #24292E"> (fork_msg) {</span></li><li value="35"><span style="color: #24292E">   </span><span style="color: #D73A49">case</span><span style="color: #24292E"> Alice: {</span></li><li value="36"><span style="color: #24292E">     </span><span style="color: #6F42C1">assert</span><span style="color: #24292E"> (</span><span style="color: #005CC5">this</span><span style="color: #24292E"> </span><span style="color: #D73A49">==</span><span style="color: #24292E"> Alice);</span></li><li value="37"><span style="color: #24292E">     </span><span style="color: #005CC5">require</span><span style="color: #24292E">(v </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="38"><span style="color: #24292E">     </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="39"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="40"><span style="color: #24292E">     </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); }</span></li><li value="41"><span style="color: #24292E">   </span><span style="color: #D73A49">case</span><span style="color: #24292E"> Bob: {</span></li><li value="42"><span style="color: #24292E">     Bob.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="43"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="44"></li><li value="45"><span style="color: #24292E">     Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showOpponent</span><span style="color: #24292E">(Bob));</span></li><li value="46"></li><li value="47"><span style="color: #24292E">     </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="48"><span style="color: #24292E">     </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="49"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="50"><span style="color: #24292E">     </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); }</span></li><li value="51"><span style="color: #24292E"> }</span></li></ol></pre>
<p>
  This pattern is tedious to write and error-prone, so the <code>fork</code> statement abbreviates it for Reach programmers.
  When a participant specifies multiple cases, the <code>msg</code> field of the participant will be wrapped with an additional
  variant signifying what case was chosen.
</p>
<h3 id="wait"><code>wait</code></h3>
<p>${ref((quote rsh), "wait")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">wait</span><span style="color: #24292E">(</span><span style="color: #005CC5">TIME</span><span style="color: #24292E">);</span></li></ol></pre>
<p>
  A ${defn("wait statement")}, written <code>wait(TIME);</code>, delays the computation until the <code>TIME</code> time argument passes.
  <code>TIME</code> must be pure and only reference values known by the consensus state.
  It may only occur in a step.
</p>
<h3 id="exit"><code>exit</code></h3>
<p>${ref((quote rsh), "exit")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>
  An ${defn("exit statement")}, written <code>exit();</code>, halts the computation.
  It is a terminator statement, so it must have an empty tail.
  It may only occur in a step.
</p>
<h2 id="expressions">Expressions</h2>
<p>
  Any expressions valid for a <a href="##ref-programs-compute-exprs">computation</a> are valid for a step.
  However, some additional expressions are allowed.
</p>
<h3 id="race"><code>race</code></h3>
<p>${ref((quote rsh), "race")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(bet);</span></li></ol></pre>
<p>
  ::: note
  If you're unsure of what kind of consensus transfer to use, you may want to read the <a href="##guide-ctransfers">explanation of the differences</a> in the Guide.
  :::
</p>
<p>A ${defn("race expression")}, written <code>race(PARTICIPANT_0, ..., PARTICIPANT_n);</code>, constructs a participant that may be used in a consensus transfer statement, such as <code>publish</code> or <code>pay</code>, where the various participants race to be the first one to perform the consensus transfer.</p>
<p>Reach provides a shorthand, <code>Anybody</code>, which serves as a <code>race</code> between all the participants.</p>
<p>
  ::: note
  See <a href="##guide-race">the guide section on races</a> to understand the benefits and dangers of using <code>race</code>.
  :::
</p>
<h3 id="unknowable"><code>unknowable</code></h3>
<p>${ref((quote rsh), "unknowable")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">unknowable</span><span style="color: #24292E">( Notter, </span><span style="color: #6F42C1">Knower</span><span style="color: #24292E">(var_0, </span><span style="color: #D73A49">...</span><span style="color: #24292E">, var_N), [msg] )</span></li></ol></pre>
<p>
  A knowledge assertion that the participant <code>Notter</code> <em>does not</em> know the results of the variables <code>var_0</code> through <code>var_N</code>, but that the participant <code>Knower</code> <em>does</em> know those values.
  It accepts an optional bytes argument, which is included in any reported violation.
</p>
<h3 id="closeto"><code>closeTo</code></h3>
<p>${ref((quote rsh), "closeTo")}</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">closeTo</span><span style="color: #24292E">( Who, after, nonNetPayAmt )</span></li></ol></pre>
<p>
  Has participant <code>Who</code> make a publication, then transfer the <code>balance()</code> and the non-network pay amount to <code>Who</code> and end the DApp after executing the function <code>after</code> in a step.
  The <code>nonNetPayAmt</code> parameter should be a pay amount. For example, when closing a program that uses a <code>Token</code> <code>token</code>, the argument would be <code>[ [balance(tok), tok] ]</code>.
  The <code>after</code> and <code>nonNetPayAmt</code> arguments are optional.
</p>