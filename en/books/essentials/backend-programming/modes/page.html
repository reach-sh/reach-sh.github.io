<p>Reach programs are organized into four modes:</p>
<ol>
  <li><a href="#initialization">Initialization</a> defines Participants, Views, and APIs, and, optionally, overrides default compilation settings.</li>
  <li><a href="#step">Step</a> defines actions taken by all participants.</li>
  <li><a href="#local-step">Local Step</a> defines actions taken by a particular participant.</li>
  <li><a href="#consensus-step">Consensus Step</a> defines actions taken by the contract.</li>
</ol>
<h2 id="transitions">Transitions</h2>
<p>The following diagram indicates mode transitions:</p>
<div>
  <img src="/en/books/essentials/backend-programming/modes/mode-transitions.png" class="img-fluid" width="500" height="390" loading="lazy">
</div>
<h2 id="consensus-transfers">Consensus Transfers</h2>
<p>A consensus transfer is a statement or expression that (a) facilitates agreement among participants, (b) transitions to a consensus step, and (3) records the agreement as a transaction on the distributed ledger (i.e. blockchain) of the consensus network. These actions include <code>publish</code>, <code>pay</code>, <code>race</code>, <code>fork</code>, and <code>parallelReduce</code>. The developer chooses which consensus transfer to use depending on the number of participants, tasks, and iterations:</p>
<table>
  <thead>
    <tr>
      <th># Participants</th>
      <th># Tasks</th>
      <th># Iterations</th>
      <th>Consensus Transfer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>One</td>
      <td>One</td>
      <td>One</td>
      <td><code>publish</code> or <code>pay</code></td>
    </tr>
    <tr>
      <td>Many</td>
      <td>One</td>
      <td>One</td>
      <td><code>race</code></td>
    </tr>
    <tr>
      <td>Many</td>
      <td>Many</td>
      <td>One</td>
      <td><code>fork</code></td>
    </tr>
    <tr>
      <td>Many</td>
      <td>Many</td>
      <td>Many</td>
      <td><code>parallelReduce</code></td>
    </tr>
  </tbody>
</table>
<p>The following list describes when to use each type of consensus transfer:</p>
<ul>
  <li>Use <code>publish</code> to cause one participant to make a value (e.g. the price of an item) available to all other participants.</li>
  <li>Use <code>pay</code> to cause one participant to pay an amount to the contract account.</li>
  <li>Use <code>race</code> when multiple participants are racing to <code>publish</code> or <code>pay</code>.</li>
  <li>Use <code>fork</code> when multiple participants are racing to do different actions.</li>
  <li>Use <code>parallelReduce</code> when muliple participants are iteratively racing or forking.</li>
</ul>
<p><code>commit</code> transitions from a consensus step to a step.</p>
<h2 id="computations">Computations</h2>
<p>All four modes support a range of statements and expressions described in <a href="/en/books/essentials/backend-programming/computations/">Computations</a>. Additionally, each mode supports the statements and expressions listed below.</p>
<h1 id="initialization">Initialization</h1>
<p>The Reach compiler recognizes <code>export const main = Reach.App(() =&gt; {}</code> as a Reach DApp. The body of <code>Reach.App</code> represents Application Initialization mode:</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">main</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> Reach.</span><span style="color: #6F42C1">App</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #6F42C1">setOptions</span><span style="color: #24292E">({ verifyArithmetic: </span><span style="color: #005CC5">true</span><span style="color: #24292E">, connectors: [</span><span style="color: #005CC5">ETH</span><span style="color: #24292E">, </span><span style="color: #005CC5">ALGO</span><span style="color: #24292E"> ] });</span></li><li value="3"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">S</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Seller'</span><span style="color: #24292E">, sellerInteract);</span></li><li value="4"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">B</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Buyer'</span><span style="color: #24292E">, buyerInteract);</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">V</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">View</span><span style="color: #24292E">(</span><span style="color: #032F62">'Main'</span><span style="color: #24292E">, { price: UInt });</span></li><li value="6"><span style="color: #24292E">  </span><span style="color: #6F42C1">deploy</span><span style="color: #24292E">();</span></li></ol></pre>
<ul>
  <li>Line 1: <code>Reach.App</code> accepts a no-argument function that specifies a DApp.</li>
  <li>Line 2: Optionally, <code>setOptions</code> overrides default compile options.</li>
  <li>Line 3-4: <code>Participant</code> specifies DApp participants.</li>
  <li>Line 5: <code>View</code> specifies DApp views.</li>
  <li>Line 6: The <code>deploy</code> function transitions from Initialization mode to Step mode.</li>
</ul>
<p>Below are descriptions of the permitted statements/expressions within Initialization:</p>
<h2 id="api">API</h2>
<p>An API is defined with <code>API(apiName, apiInterface)</code> or <code>API(apiInterface)</code>:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">API</span><span style="color: #24292E">(</span><span style="color: #032F62">'Voter'</span><span style="color: #24292E">, { vote: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([Address], UInt) })</span></li><li value="2"><span style="color: #6F42C1">API</span><span style="color: #24292E">({ vote: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([Address], UInt) })</span></li></ol></pre>
<p><code>apiName</code> is a string that labels the API and <code>apiInterface</code> is an object where each field indicates the type of a function provided by the contract as an API. These APIs are available in frontends via the <code>ctc.apis</code> object. The value returned by this function is an object where the fields are the members of apiInterface are may be used in .api components of fork and parallelReduce to specify the behavior of the corresponding call. These are called API member functions. Each function must occur exactly once in the entire program.</p>
<h2 id="deploy">deploy</h2>
<p>The <code>deploy()</code> statement deploys the DApp and finalizes all the available APIs, Participants, Views, and compilation options. Its continuation is a step, which means its content is specified by steps. It represents the body of the DApp to be compiled.</p>
<h2 id="participant">Participant</h2>
<p>A participant is declared with the following:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(participantName, participantInteractInterface)</span></li></ol></pre>
<p><code>participantName</code> is a string which indicates the name of the participant function in the generated backend code. Each <code>participantName</code> must be unique.</p>
<p><code>participantInteractInterface</code> is a participant interact interface, an object where each field indicates the type of a function or value which must be provided to the backend by the frontend for interacting with the participant.</p>
<h2 id="participantclass">ParticipantClass</h2>
<p>A participant is declared with the following:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">ParticipantClass</span><span style="color: #24292E">(participantName, participantInteractInterface)</span></li></ol></pre>
<p><code>participantName</code> is a string which indicates the name of the participant function in the generated backend code. Each <code>participantName</code> must be unique.</p>
<p><code>participantInteractInterface</code> is a participant interact interface, an object where each field indicates the type of a function or value which must be provided to the backend by the frontend for interacting with the participant.</p>
<h2 id="setoptions">setOptions</h2>
<p>The <code>setOptions({})</code> statement overrides default application parameters. Here is an example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">setOptions</span><span style="color: #24292E">({ verifyArithmetic: </span><span style="color: #005CC5">true</span><span style="color: #24292E">, connectors: [</span><span style="color: #005CC5">ETH</span><span style="color: #24292E">, </span><span style="color: #005CC5">ALGO</span><span style="color: #24292E"> ] });</span></li></ol></pre>
<p>Possible options include the following:</p>
<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Type</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>connectors</code></td>
      <td><code>Array</code></td>
      <td><code>[ALGO, ETH]</code></td>
    </tr>
    <tr>
      <td><code>verifyArithmetic</code></td>
      <td><code>Boolean</code></td>
      <td><code>false</code></td>
    </tr>
    <tr>
      <td><code>verifyPerConnector</code></td>
      <td><code>Boolean</code></td>
      <td><code>false</code></td>
    </tr>
  </tbody>
</table>
<p>Descriptions:</p>
<ul>
  <li><em>connectors</em>. A tuple of the connectors that the application should be compiled for. By default, all available connectors are chosen.</li>
  <li><em>verifyArithmetic</em>. Determines whether arithmetic operations automatically introduce static assertions that they do not overflow beyond UInt.max. This defaults to false, because it is onerous to verify. We recommend turning it on before final deployment, but leaving it off during development. When it is false, connectors will ensure that overflows do not actually occur on the network.</li>
  <li><em>verifyPerConnector</em>. Determines whether verification is done per connector, or once for a generic connector. When this is true, then connector-specific constants, like UInt.max, will be instantiated to literal numbers. This concretization of these constants can induce performance degradation in the verifier.</li>
</ul>
<h2 id="view">View</h2>
<p>A view is defined with <code>View(viewName, viewInterface)</code> or <code>View(viewInterface)</code>:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">View</span><span style="color: #24292E">(</span><span style="color: #032F62">'NFT'</span><span style="color: #24292E">, { owner: Address })</span></li><li value="2"><span style="color: #6F42C1">View</span><span style="color: #24292E">({ owner: Address })</span></li></ol></pre>
<p><code>viewName</code> is a string that labels the view and <code>viewInterface</code> is an object where each field indicates the type of a function or value provided by the contract associated with the specified DApp. These views are available in frontends via the ctc.views object. In the DApp, the result of this application argument is referred to as a view object.</p>
<h1 id="step">Step</h1>
<p>Actions that apply to all participants occur within a step. Below are descriptions of the permitted statements/expressions within a Step:</p>
<h2 id="call">call</h2>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">DOMAIN</span><span style="color: #24292E">, </span><span style="color: #005CC5">RET_FUN</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">call</span><span style="color: #24292E">(</span><span style="color: #005CC5">API_EXPR</span><span style="color: #24292E">)</span></li><li value="2"><span style="color: #24292E">  .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(</span><span style="color: #005CC5">API_PAY_EXPR</span><span style="color: #24292E">)</span></li><li value="3"><span style="color: #24292E">  .</span><span style="color: #6F42C1">assume</span><span style="color: #24292E">(</span><span style="color: #005CC5">API_ASSUME_EXPR</span><span style="color: #24292E">)</span></li><li value="4"><span style="color: #24292E">  .</span><span style="color: #6F42C1">throwTimeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, </span><span style="color: #005CC5">THROW_EXPR</span><span style="color: #24292E">)</span></li></ol></pre>
<ul>
  <li><code>DOMAIN</code> is the domain of the API member function.</li>
  <li><code>RET_FUN</code> is a function that returns a value to the API call. This function must be called.</li>
  <li><code>API_EXPR</code> is an expression that evaluates to an API member function.</li>
  <li><code>API_PAY_EXPR</code>, <code>API_ASSUME_EXPR</code>, and <code>throwTimeout</code> are optional. See <a href="#fork">Fork</a>.</li>
</ul>
<p>The statement transitions the program from a step to a consensus step. It calls the given API member function, returns a pair <code>[DOMAIN, RET_FUN]</code>, and publishes the domain of the API member function.</p>
<p>Here is an example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">A</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">API</span><span style="color: #24292E">(</span><span style="color: #032F62">'A'</span><span style="color: #24292E">, { isGt: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt, UInt], Bool); });</span></li><li value="2"><span style="color: #6A737D">// ...</span></li><li value="3"><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">dom</span><span style="color: #24292E">, </span><span style="color: #005CC5">k</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">call</span><span style="color: #24292E">(</span><span style="color: #005CC5">A</span><span style="color: #24292E">.isGt).</span><span style="color: #6F42C1">assume</span><span style="color: #24292E">((</span><span style="color: #E36209">x</span><span style="color: #24292E">, </span><span style="color: #E36209">y</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> x </span><span style="color: #D73A49">!=</span><span style="color: #24292E"> y).</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">((</span><span style="color: #E36209">x</span><span style="color: #24292E">, </span><span style="color: #E36209">y</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> x);</span></li><li value="4"><span style="color: #D73A49">const</span><span style="color: #24292E"> [</span><span style="color: #005CC5">x</span><span style="color: #24292E">, </span><span style="color: #005CC5">y</span><span style="color: #24292E">] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> dom;</span></li><li value="5"><span style="color: #6F42C1">k</span><span style="color: #24292E">(x </span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> y);</span></li><li value="6"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li></ol></pre>
<h2 id="closeto">closeTo</h2>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">closeTo</span><span style="color: #24292E">( Who, after, nonNetPayAmt )</span></li></ol></pre>
<p>The statement has participant Who make a publication, then transfer the balance() and the non-network <a href="/en/books/essentials/terminology/#pay-amount">pay amount</a> to Who and end the DApp after executing the function after in a step. The nonNetPayAmt parameter should be a <a href="/en/books/essentials/terminology/#pay-amount">pay amount</a>. For example, when closing a program that uses a Token token, the argument would be [ [balance(tok), tok] ]. The after and nonNetPayAmt arguments are optional.</p>
<h2 id="exit">exit</h2>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>An exit statement, written exit();, halts the computation. It is a terminator statement, so it must have an empty tail. It may only occur in a step.</p>
<h2 id="fork">fork</h2>
<p>A fork statement is an abbreviation of a common race and switch pattern you could write yourself. The idea is that each of the participants in the case components do an independent local step evaluation of a value they would like to publish and then all race to publish their value. The one that "wins" the race then determines not only the value (&amp; pay expression), but also what consensus step code runs to consume the value. The sample fork statement linked to the fork keyword is roughly equivalent to:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6A737D">// We first define a Data instance so that each participant can publish a</span></li><li value="2"><span style="color: #6A737D">// different kind of value</span></li><li value="3"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ForkData</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Data</span><span style="color: #24292E">({Alice: UInt, Bob: Null});</span></li><li value="4"><span style="color: #6A737D">// Then we bind these values for each participant</span></li><li value="5"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="6"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_msg</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ForkData.</span><span style="color: #6F42C1">Alice</span><span style="color: #24292E">(</span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="7"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_when</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()); });</span></li><li value="8"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="9"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_msg</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ForkData.</span><span style="color: #6F42C1">Bob</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">);</span></li><li value="10"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fork_when</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()); });</span></li><li value="11"><span style="color: #6A737D">// They race</span></li><li value="12"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob)</span></li><li value="13"><span style="color: #24292E"> .</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(fork_msg)</span></li><li value="14"><span style="color: #24292E"> .</span><span style="color: #6F42C1">when</span><span style="color: #24292E">(fork_when)</span></li><li value="15"><span style="color: #24292E"> </span><span style="color: #6A737D">// The pay ammount depends on who is publishing</span></li><li value="16"><span style="color: #24292E"> .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(fork_msg.</span><span style="color: #6F42C1">match</span><span style="color: #24292E">( {</span></li><li value="17"><span style="color: #24292E">   Alice: (</span><span style="color: #E36209">v</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> v),</span></li><li value="18"><span style="color: #24292E">   Bob: ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> wager) } ))</span></li><li value="19"><span style="color: #24292E"> </span><span style="color: #6A737D">// The timeout is always the same</span></li><li value="20"><span style="color: #24292E"> .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="21"><span style="color: #24292E">   </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="22"><span style="color: #24292E">   </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="23"><span style="color: #24292E">   </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="24"><span style="color: #24292E">   </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="25"></li><li value="26"><span style="color: #24292E"> </span><span style="color: #6A737D">// We ensure that the correct participant published the correct kind of value</span></li><li value="27"><span style="color: #24292E"> </span><span style="color: #005CC5">require</span><span style="color: #24292E">(fork_msg.</span><span style="color: #6F42C1">match</span><span style="color: #24292E">( {</span></li><li value="28"><span style="color: #24292E">   </span><span style="color: #6A737D">// Alice had previously published</span></li><li value="29"><span style="color: #24292E">   Alice: (</span><span style="color: #E36209">v</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E"> </span><span style="color: #D73A49">==</span><span style="color: #24292E"> Alice),</span></li><li value="30"><span style="color: #24292E">   </span><span style="color: #6A737D">// But Bob had not.</span></li><li value="31"><span style="color: #24292E">   Bob: ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">) } ));</span></li><li value="32"></li><li value="33"><span style="color: #24292E"> </span><span style="color: #6A737D">// Then we select the appropriate body to run</span></li><li value="34"><span style="color: #24292E"> </span><span style="color: #D73A49">switch</span><span style="color: #24292E"> (fork_msg) {</span></li><li value="35"><span style="color: #24292E">   </span><span style="color: #D73A49">case</span><span style="color: #24292E"> Alice: {</span></li><li value="36"><span style="color: #24292E">     </span><span style="color: #6F42C1">assert</span><span style="color: #24292E"> (</span><span style="color: #005CC5">this</span><span style="color: #24292E"> </span><span style="color: #D73A49">==</span><span style="color: #24292E"> Alice);</span></li><li value="37"><span style="color: #24292E">     </span><span style="color: #005CC5">require</span><span style="color: #24292E">(v </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="38"><span style="color: #24292E">     </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="39"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="40"><span style="color: #24292E">     </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); }</span></li><li value="41"><span style="color: #24292E">   </span><span style="color: #D73A49">case</span><span style="color: #24292E"> Bob: {</span></li><li value="42"><span style="color: #24292E">     Bob.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="43"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="44"></li><li value="45"><span style="color: #24292E">     Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showOpponent</span><span style="color: #24292E">(Bob));</span></li><li value="46"></li><li value="47"><span style="color: #24292E">     </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="48"><span style="color: #24292E">     </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="49"><span style="color: #24292E">     </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="50"><span style="color: #24292E">     </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); }</span></li><li value="51"><span style="color: #24292E"> }</span></li></ol></pre>
<p>This pattern is tedious to write and error-prone, so the fork statement abbreviates it for Reach programmers. When a participant specifies multiple cases, the msg field of the participant will be wrapped with an additional variant signifying what case was chosen.</p>
<p>A fork statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">fork</span><span style="color: #24292E">()</span></li><li value="2"><span style="color: #24292E">.</span><span style="color: #6F42C1">paySpec</span><span style="color: #24292E">(</span><span style="color: #005CC5">TOKENS_EXPR</span><span style="color: #24292E">)</span></li><li value="3"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span><span style="color: #005CC5">PART_EXPR</span><span style="color: #24292E">,</span></li><li value="4"><span style="color: #24292E">  </span><span style="color: #005CC5">PUBLISH_EXPR</span><span style="color: #24292E">,</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="6"><span style="color: #24292E">  </span><span style="color: #005CC5">CONSENSUS_EXPR</span><span style="color: #24292E">)</span></li><li value="7"><span style="color: #24292E">.</span><span style="color: #6F42C1">api</span><span style="color: #24292E">(</span><span style="color: #005CC5">API_EXPR</span><span style="color: #24292E">,</span></li><li value="8"><span style="color: #24292E">  </span><span style="color: #005CC5">API_ASSUME_EXPR</span><span style="color: #24292E">,</span></li><li value="9"><span style="color: #24292E">  </span><span style="color: #005CC5">API_PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="10"><span style="color: #24292E">  </span><span style="color: #005CC5">API_CONSENSUS_EXPR</span><span style="color: #24292E">)</span></li><li value="11"><span style="color: #24292E">.</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span></li><li value="12"><span style="color: #24292E">  </span><span style="color: #005CC5">TIMEOUT_BLOCK</span><span style="color: #24292E">);</span></li><li value="13"><span style="color: #6A737D">// or</span></li><li value="14"><span style="color: #24292E">.</span><span style="color: #6F42C1">throwTimeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, </span><span style="color: #005CC5">THROW_EXPR</span><span style="color: #24292E">)</span></li></ol></pre>
<ul>
  <li><code>TOKENS_EXPR</code> is an expression that evaluates to a tuple of Tokens;</li>
  <li><code>PART_EXPR</code> is an expression that evaluates to a participant;</li>
  <li><code>PUBLISH_EXPR</code> is a syntactic arrow expression that is evaluated in a local step for the specified participant and must evaluate to an object that may contain a msg field, which may be of any type, and a when field, which must be a boolean;</li>
  <li>(optional) <code>PAY_EXPR</code> is an expression that evaluates to a function parameterized over the msg value and returns a <a href="/en/books/essentials/terminology/#pay-amount">pay amount</a>; if this component is left-out, it is synthesized to zero;</li>
  <li><code>CONSENSUS_EXPR</code> is a syntactic arrow expression parameterized over the msg value which is evaluated in a consensus step;</li>
  <li><code>API_EXPR</code> is an expression that evaluates to an API member function;</li>
  <li>(optional) <code>API_ASSUME_EXPR</code> is a function parameterized over the input to the API member function which is evaluated for effect in a local step; thus it may be used to add assume constraints on the values given by the API; if this is absent, then it is synthesized to an empty function; if it is present, then API_PAY_EXPR must be included;</li>
  <li>(optional) <code>API_PAY_EXPR</code> is a function parameterized over the input to the API member function which is evaluated to determine the <a href="/en/books/essentials/terminology/#pay-amount">pay amount</a>, like PAY_EXPR;</li>
  <li><code>API_CONSENSUS_EXPR</code> is a function parameterized over the input to the API member function and a function that returns a value to the API call; this function must be called;</li>
  <li>the timeout and throwTimeout parameter are as in an consensus transfer.</li>
</ul>
<p>Here is an example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">fork</span><span style="color: #24292E">()</span></li><li value="2"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Alice, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="3"><span style="color: #24292E">  msg: </span><span style="color: #005CC5">19</span><span style="color: #24292E">,</span></li><li value="4"><span style="color: #24292E">  when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="5"><span style="color: #24292E">  ((</span><span style="color: #E36209">v</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> v),</span></li><li value="6"><span style="color: #24292E">  (</span><span style="color: #E36209">v</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="7"><span style="color: #24292E">    </span><span style="color: #005CC5">require</span><span style="color: #24292E">(v </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">);</span></li><li value="8"><span style="color: #24292E">    </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">19</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="9"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="10"><span style="color: #24292E">    </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li><li value="11"><span style="color: #24292E">  })</span></li><li value="12"><span style="color: #24292E">.</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Bob, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="13"><span style="color: #24292E">  when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="14"><span style="color: #24292E">  ((</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> wager),</span></li><li value="15"><span style="color: #24292E">  (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="16"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="17"></li><li value="18"><span style="color: #24292E">    Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showOpponent</span><span style="color: #24292E">(Bob));</span></li><li value="19"></li><li value="20"><span style="color: #24292E">    </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="21"><span style="color: #24292E">    </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="22"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="23"><span style="color: #24292E">    </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li><li value="24"><span style="color: #24292E">  })</span></li><li value="25"><span style="color: #24292E">.</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="26"><span style="color: #24292E">  </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="27"><span style="color: #24292E">  </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(wager).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">);</span></li><li value="28"><span style="color: #24292E">  </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="29"><span style="color: #24292E">  </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li></ol></pre>
<h2 id="each-and-only">each and only</h2>
<p>Local steps occur in the body of each and only statements.</p>
<p>The statements are written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">each</span><span style="color: #24292E">([Alice, Bob], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">pretzel</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">random</span><span style="color: #24292E">(); });</span></li><li value="2"></li><li value="3"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">pretzel</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">random</span><span style="color: #24292E">(); });</span></li></ol></pre>
<p>A local step statement is written PART.only(() =&gt; BLOCK), where PART is a participant identifier and BLOCK is a block. Within BLOCK, PART is bound to the address of the participant. Any bindings defined within the block of a local step are available in the statement’s tail as new local state. For example,</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="2"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">y</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li></ol></pre>
<p>is a valid program where Alice’s local state includes the private values x (bound to 3) and y (bound to 4). However, such bindings are not consensus state, so they are purely local state. For example,</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="2"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">y</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> x </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li></ol></pre>
<p>is an invalid program, because Bob does not know x.</p>
<p>The interact shorthand, written PART.interact.METHOD(EXPR_0, ..., EXPR_n), is available for calling an interact function from outside of an only block. Such functions must return Null; therefore, they are only useful if they produce side-effects, such as logging on the frontend. For example, the function log in the participant interact interface of Alice may be called via:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.interact.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(x);</span></li></ol></pre>
<h2 id="publish-pay-when-timeout">publish, pay, when, timeout</h2>
<p>A consensus transfer is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #005CC5">PART_EXPR</span><span style="color: #24292E">.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(</span><span style="color: #005CC5">ID_0</span><span style="color: #24292E">, </span><span style="color: #D73A49">...</span><span style="color: #24292E">, ID_n)</span></li><li value="2"><span style="color: #24292E"> .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(</span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">)</span></li><li value="3"><span style="color: #24292E"> .</span><span style="color: #6F42C1">when</span><span style="color: #24292E">(</span><span style="color: #005CC5">WHEN_EXPR</span><span style="color: #24292E">)</span></li><li value="4"><span style="color: #24292E"> .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span></li><li value="5"><span style="color: #24292E">   </span><span style="color: #005CC5">TIMEOUT_BLOCK</span><span style="color: #24292E">)</span></li><li value="6"><span style="color: #24292E"> </span><span style="color: #6A737D">// or</span></li><li value="7"><span style="color: #24292E"> .</span><span style="color: #6F42C1">throwTimeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, </span><span style="color: #005CC5">THROWN_EXPR</span><span style="color: #24292E">)</span></li></ol></pre>
<p>where PART_EXPR is an expression that evaluates to a participant or race expression, ID_0 through ID_n are identifiers for PART’s public local state, PAY_EXPR is a public expression evaluating to a <a href="/en/books/essentials/terminology/#pay-amount">pay amount</a>, WHEN_EXPR is a public expression evaluating to a boolean and determines if the consensus transfer takes place, DELAY_EXPR is a public expression that depends on only consensus state and evaluates to a time argument, TIMEOUT_BLOCK is a timeout block, which will be executed after the DELAY_EXPR time argument passes without PART executing this consensus transfer.</p>
<p>All of the expressions within a consensus transfer are evaluated in a pure context, which may not alter the state of the application. The PAY_EXPR, WHEN_EXPR, and DELAY_EXPR expressions must refer only to the consensus state, including the new data published via the .publish component.</p>
<p>The continuation of a consensus transfer statement is a consensus step, which is finalized with a commit statement. The continuation of a timeout block is the same as the continuation of the function the timeout occurs within.</p>
<p>The publish component exclusive-or the pay component may be omitted, if either there is no publication or no transfer of network tokens to accompany this consensus transfer. The when component may always be omitted, in which case it is assumed to be true. publish or pay must occur first, after which components may occur in any order. For example, the following are all valid:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip);</span></li><li value="2"></li><li value="3"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount);</span></li><li value="4"></li><li value="5"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip);</span></li><li value="6"></li><li value="7"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(coinFlip)</span></li><li value="8"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">closeTo</span><span style="color: #24292E">(Bob, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">()));</span></li><li value="9"></li><li value="10"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(penaltyAmount)</span></li><li value="11"><span style="color: #24292E">     .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="12"><span style="color: #24292E">       Bob.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="13"><span style="color: #24292E">       </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="14"><span style="color: #24292E">       </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="15"></li><li value="16"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(bid).</span><span style="color: #6F42C1">when</span><span style="color: #24292E">(wantsToBid);</span></li></ol></pre>
<p>The timeout component must be included if when is not statically true. This ensures that your clients will eventually complete the program. If a consensus transfer is a guaranteed race between non-class participants and a participant class that may attempt to transfer (i.e. when is not statically false), then a timeout may be explicitly omitted by writing .timeout(false).</p>
<p>.throwTimeout may be used in place of .timeout. It accepts a DELAY_EXPR and an EXPR, which will be thrown if a timeout should occur. If an EXPR is not provided, then null will be thrown. If a consensus transfer uses .throwTimeout, it must be within a try statement.</p>
<p>If a consensus transfer specifies a single participant, which has not yet been fixed in the application and is not a participant class, then this statement does so; therefore, after it the PART may be used as an address.</p>
<p>If a consensus transfer specificies a single participant class, then all members of that class will attempt to perform the transfer, but only one will succeed.</p>
<p>A consensus transfer binds the identifiers ID_0 through ID_n for all participants to the values included in the consensus transfer, overwriting any bindings that already exist for those identifiers. If an existing participant, not included in PART_EXPR, has previously bound one of these identifiers, then the program is not valid. In other words, the following program is not valid:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">Alice.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; });</span></li><li value="3"><span style="color: #24292E">Bob.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E">; });</span></li><li value="5"><span style="color: #24292E">Claire.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="6"><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">x</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">; });</span></li><li value="7"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(x);</span></li><li value="8"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>because Claire is not included in the race. However, if we were to rename Claire’s x into y, then it would be valid, because although Alice and Bob both bind x, they participate in the race, so it is allowed. In the tail of this program, x is bound to either 1 or 2, i.e., either Alice or Bob’s value is overwritten. This overwriting applies even if Alice wins and Alice is a participant class, i.e., the value of x in the tail is guaranteed to be the single value that was agreed upon in the consensus.</p>
<h2 id="race">race</h2>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(bet);</span></li></ol></pre>
<p>A race expression, written race(PARTICIPANT_0, ..., PARTICIPANT_n);, constructs a participant that may be used in a consensus transfer statement, such as publish or pay, where the various participants race to be the first one to perform the consensus transfer. Reach provides a shorthand, Anybody, which serves as a race between all the participants.</p>
<h2 id="unknowable">unknowable</h2>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">unknowable</span><span style="color: #24292E">( Notter, </span><span style="color: #6F42C1">Knower</span><span style="color: #24292E">(var_0, </span><span style="color: #D73A49">...</span><span style="color: #24292E">, var_N), [msg] )</span></li></ol></pre>
<p>A knowledge assertion that the participant Notter does not know the results of the variables var_0 through var_N, but that the participant Knower does know those values. It accepts an optional bytes argument, which is included in any reported violation.</p>
<h2 id="wait">wait</h2>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">wait</span><span style="color: #24292E">(</span><span style="color: #005CC5">TIME</span><span style="color: #24292E">);</span></li></ol></pre>
<p>A wait statement, written wait(TIME);, delays the computation until the TIME time argument passes. TIME must be pure and only reference values known by the consensus state. It may only occur in a step.</p>
<h1 id="local-step">Local Step</h1>
<p>A Reach local step occurs in the body of <a href="#each-and-only">each and only</a> statements. It represents the actions taken by a single participant in an application. Inside a local step, <code>this</code> refers to the participant performing the step. This is useful when the local step was initiated by an <code>each</code> expression. Below are descriptions of the permitted statements/expressions within a Local Step:</p>
<h2 id="assume">assume</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">assume</span><span style="color: #24292E">( claim, [msg] )</span></li></ol></pre>
<p>An assumption where claim evaluates to true with honest frontends. This may only appear in a local step. It accepts an optional bytes argument, which is included in any reported violation.</p>
<h2 id="declassify">declassify</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">declassify</span><span style="color: #24292E">( arg )</span></li></ol></pre>
<p>The declassify primitive performs a declassification of the given argument.</p>
<h2 id="didpublish">didPublish</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">didPublish</span><span style="color: #24292E">()</span></li></ol></pre>
<p>Returns a boolean that indicates whether the last publication was made by this principal.</p>
<h2 id="fail">fail</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">fail</span><span style="color: #24292E">()</span></li></ol></pre>
<p><code>fail</code> is a convenience method equivalent to assume(false). This may only appear in a local step.</p>
<h2 id="interact">interact</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">interact.amount</span></li><li value="2"><span style="color: #24292E">interact.</span><span style="color: #6F42C1">notify</span><span style="color: #24292E">(handA, handB)</span></li><li value="3"><span style="color: #24292E">interact.</span><span style="color: #6F42C1">chooseAmount</span><span style="color: #24292E">(heap1, heap2)</span></li></ol></pre>
<p>An interaction expression, written interact.METHOD(EXPR_0, ..., EXPR_n), where METHOD is an identifier bound in the participant interact interface to a function type, and EXPR_0 through EXPR_n are expressions that evaluate to the result of an interaction with a frontend that receives the evaluation of the n expressions and sends a value.</p>
<p>An interaction expression may also be written interact.KEY, where KEY is bound in the participant interact interface to a non-function type.</p>
<p>An interaction expression may only occur in a local step.</p>
<h2 id="makecommitment">makeCommitment</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">makeCommitment</span><span style="color: #24292E">( interact, x )</span></li></ol></pre>
<p>Returns two values, [ commitment, salt ], where salt is the result of calling interact.random(), and commitment is the digest of salt and x. This is used in a local step before checkCommitment is used in a consensus step.</p>
<h1 id="consensus-step">Consensus Step</h1>
<p>A Reach consensus step occurs in the continuation of a consensus transfer statement. It represents the actions taken by the consensus network contract of an application. Inside of a consensus step, <code>this</code> refers to the address of the participant that performed the consensus transfer. This is useful when the consensus transfer was initiated by a race expression. Below are descriptions of the permitted statements/expressions within a Consensus Step:</p>
<h2 id="checkcommitment">checkCommitment</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">checkCommitment</span><span style="color: #24292E">( commitment, salt, x )</span></li></ol></pre>
<p>Makes a requirement that commitment is the digest of salt and x. This is used in a consensus step after makeCommitment was used in a local step.</p>
<h2 id="commit">commit</h2>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>A commit statement, written commit();, commits to statement’s continuation as the next step of the DApp computation. In other words, it ends the current consensus step and allows more local steps.</p>
<h2 id="continue">continue</h2>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">[ heap1, heap2 ] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [ heap1 </span><span style="color: #D73A49">-</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">, heap2 ];</span></li><li value="2"><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></li></ol></pre>
<p>A continue statement may occur within a while statement’s block and is written:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #005CC5">LHS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">UPDATE_EXPR</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></li></ol></pre>
<p>where the identifiers bound by LHS are a subset of the variables bound by the nearest enclosing while statement and UPDATE_EXPR is an expression which may be bound by LHS.</p>
<p>A continue statement is a terminator statement, so it must have an empty tail.</p>
<p>A continue statement may be written without the preceding identifier update, which is equivalent to writing</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #24292E">[] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [];</span></li><li value="2"><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></li></ol></pre>
<p>A continue statement must be dominated by a consensus transfer, which means that the body of a while statement must always commit(); before calling continue;. This restriction may be lifted in future versions of Reach, which will perform termination checking.</p>
<p>As a special case, a continue statement may occur in a step, if the UPDATE_EXPR transitions to a consensus step. In other words, this is a valid program:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="2"><span style="color: #24292E"> </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="3"><span style="color: #24292E"> </span><span style="color: #005CC5">A</span><span style="color: #24292E">.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="4"><span style="color: #24292E"> </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></li><li value="5"><span style="color: #24292E">};</span></li><li value="6"></li><li value="7"><span style="color: #D73A49">var</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></li><li value="8"><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">);</span></li><li value="9"><span style="color: #D73A49">while</span><span style="color: #24292E"> ( x </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ) {</span></li><li value="10"><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">();</span></li><li value="11"><span style="color: #24292E"> </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></li><li value="12"><span style="color: #24292E">}</span></li></ol></pre>
<h2 id="each-and-only-consensus">each and only (consensus)</h2>
<p><a href="#each-and-only">each and only</a> are allowed in consensus steps and are executed by backends once they observe the completion of the consensus step (i.e., after the associated commit statement.)</p>
<h2 id="map">Map</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">bidsM</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Map</span><span style="color: #24292E">(UInt);</span></li><li value="2"><span style="color: #24292E">bidsM[</span><span style="color: #005CC5">this</span><span style="color: #24292E">] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">17</span><span style="color: #24292E">;</span></li><li value="3"><span style="color: #D73A49">delete</span><span style="color: #24292E"> bidsM[</span><span style="color: #005CC5">this</span><span style="color: #24292E">];</span></li></ol></pre>
<p>A new mapping of linear state may be constructed in a consensus step by writing new Map(TYPE_EXPR), where TYPE_EXPR is some type.</p>
<p>This returns a value which may be used to dereference particular mappings via map[ADDR_EXPR], where ADDR_EXPR is an address. Such dereferences return a value of type Maybe(TYPE_EXPR), because the mapping may not contain a value for ADDR_EXPR.</p>
<p>A mapping may be modified by writing map[ADDR_EXPR] = VALUE_EXPR to install VALUE_EXPR (of type TYPE_EXPR) at ADDR_EXPR, or by writing delete map[ADDR_EXPR] to remove the mapping entry. Such modifications may only occur in a consensus step.</p>
<h2 id="parallelreduce">parallelReduce</h2>
<p>A parallel reduce statement is essentially an abbreviation of pattern of a while loop combined with a fork statement that you could write yourself. This is an extremely common pattern in decentralized applications.</p>
<p>The idea is that there are some values (the LHS) which after intialization will be repeatedly updated uniquely by each of the racing participants until the condition does not hold:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #005CC5">LHS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">INIT_EXPR</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #005CC5">DEFINE_BLOCK</span><span style="color: #24292E">;</span></li><li value="3"><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #005CC5">INVARIANT_EXPR</span><span style="color: #24292E">);</span></li><li value="4"><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">COND_EXPR</span><span style="color: #24292E">) {</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #6F42C1">fork</span><span style="color: #24292E">()</span></li><li value="6"><span style="color: #24292E">  .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span><span style="color: #005CC5">PART_EXPR</span><span style="color: #24292E">,</span></li><li value="7"><span style="color: #24292E">    </span><span style="color: #005CC5">PUBLISH_EXPR</span><span style="color: #24292E">,</span></li><li value="8"><span style="color: #24292E">    </span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="9"><span style="color: #24292E">    (</span><span style="color: #E36209">m</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="10"><span style="color: #24292E">      </span><span style="color: #005CC5">LHS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CONSENSUS_EXPR</span><span style="color: #24292E">(m);</span></li><li value="11"><span style="color: #24292E">      </span><span style="color: #D73A49">continue</span><span style="color: #24292E">; })</span></li><li value="12"><span style="color: #24292E">  .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span></li><li value="13"><span style="color: #24292E">    </span><span style="color: #005CC5">TIMEOUT_BLOCK</span><span style="color: #24292E">);</span></li><li value="14"><span style="color: #24292E">}</span></li></ol></pre>
<p>The statement is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">LHS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #6F42C1">parallelReduce</span><span style="color: #24292E">(</span><span style="color: #005CC5">INIT_EXPR</span><span style="color: #24292E">)</span></li><li value="3"><span style="color: #24292E">  .</span><span style="color: #6F42C1">define</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">DEFINE_BLOCK</span><span style="color: #24292E">)</span></li><li value="4"><span style="color: #24292E">  .</span><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #005CC5">INVARIANT_EXPR</span><span style="color: #24292E">)</span></li><li value="5"><span style="color: #24292E">  .</span><span style="color: #6F42C1">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">COND_EXPR</span><span style="color: #24292E">)</span></li><li value="6"><span style="color: #24292E">  .</span><span style="color: #6F42C1">paySpec</span><span style="color: #24292E">(</span><span style="color: #005CC5">TOKENS_EXPR</span><span style="color: #24292E">)</span></li><li value="7"><span style="color: #24292E">  .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span><span style="color: #005CC5">PART_EXPR</span><span style="color: #24292E">,</span></li><li value="8"><span style="color: #24292E">    </span><span style="color: #005CC5">PUBLISH_EXPR</span><span style="color: #24292E">,</span></li><li value="9"><span style="color: #24292E">    </span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="10"><span style="color: #24292E">    </span><span style="color: #005CC5">CONSENSUS_EXPR</span><span style="color: #24292E">)</span></li><li value="11"><span style="color: #24292E">  .</span><span style="color: #6F42C1">api</span><span style="color: #24292E">(</span><span style="color: #005CC5">API_EXPR</span><span style="color: #24292E">,</span></li><li value="12"><span style="color: #24292E">    </span><span style="color: #005CC5">ASSUME_EXPR</span><span style="color: #24292E">,</span></li><li value="13"><span style="color: #24292E">    </span><span style="color: #005CC5">PAY_EXPR</span><span style="color: #24292E">,</span></li><li value="14"><span style="color: #24292E">    </span><span style="color: #005CC5">CONSENSUS_EXPR</span><span style="color: #24292E">)</span></li><li value="15"><span style="color: #24292E">  .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #005CC5">DELAY_EXPR</span><span style="color: #24292E">, () </span><span style="color: #D73A49">=&gt;</span></li><li value="16"><span style="color: #24292E">    </span><span style="color: #005CC5">TIMEOUT_BLOCK</span><span style="color: #24292E">);</span></li></ol></pre>
<p>The LHS and INIT_EXPR are like the initialization component of a while loop; and, the .invariant and .while components are like the invariant and condition of a while loop; the DEFINE_BLOCK is like the DEFINE_BLOCK of a while loop; while the .case, .api, .timeout, and .paySpec components are like the corresponding components of a fork statement.</p>
<p>The .case component may be repeated many times, just like in a fork statement.</p>
<p>The .define component may define bindings that reference the LHS values. These bindings are accessible from every component of the parallelReduce statement, except for the INIT_EXPR.</p>
<p>Here is an example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">keepGoing</span><span style="color: #24292E">, </span><span style="color: #005CC5">as</span><span style="color: #24292E">, </span><span style="color: #005CC5">bs</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #6F42C1">parallelReduce</span><span style="color: #24292E">([ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ])</span></li><li value="3"><span style="color: #24292E">  .</span><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wager)</span></li><li value="4"><span style="color: #24292E">  .</span><span style="color: #6F42C1">while</span><span style="color: #24292E">(keepGoing)</span></li><li value="5"><span style="color: #24292E">  .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Alice, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="6"><span style="color: #24292E">    when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="7"><span style="color: #24292E">    (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="8"><span style="color: #24292E">      </span><span style="color: #6F42C1">each</span><span style="color: #24292E">([Alice, Bob], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="9"><span style="color: #24292E">        interact.</span><span style="color: #6F42C1">roundWinnerWas</span><span style="color: #24292E">(</span><span style="color: #005CC5">true</span><span style="color: #24292E">); });</span></li><li value="10"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> as, bs ]; })</span></li><li value="11"><span style="color: #24292E">  .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(Bob, (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="12"><span style="color: #24292E">    when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">keepGoing</span><span style="color: #24292E">()) })),</span></li><li value="13"><span style="color: #24292E">    (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="14"><span style="color: #24292E">      </span><span style="color: #6F42C1">each</span><span style="color: #24292E">([Alice, Bob], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="15"><span style="color: #24292E">        interact.</span><span style="color: #6F42C1">roundWinnerWas</span><span style="color: #24292E">(</span><span style="color: #005CC5">false</span><span style="color: #24292E">); });</span></li><li value="16"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, as, </span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> bs ]; })</span></li><li value="17"><span style="color: #24292E">  .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="18"><span style="color: #24292E">    </span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E">(</span><span style="color: #005CC5">TIMEOUT</span><span style="color: #24292E">)();</span></li><li value="19"><span style="color: #24292E">    </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Alice, Bob).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="20"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">false</span><span style="color: #24292E">, as, bs ]; });</span></li></ol></pre>
<h2 id="remote">remote</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">randomOracle</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #6F42C1">remote</span><span style="color: #24292E">( randomOracleCtcInfo, {</span></li><li value="3"><span style="color: #24292E">    getRandom: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], UInt),</span></li><li value="4"><span style="color: #24292E">  });</span></li><li value="5"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">randomVal</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> randomOracle.getRandom.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(randomFee)();</span></li></ol></pre>
<p>A remote object represents a foreign contract in a Reach application. During a consensus step, a Reach computation may consensually communicate with such an object via a prescribed interface.</p>
<p>A remote object is constructed by calling the remote function with a Contract and an interface—an object where each key is bound to a function type. For example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">randomOracle</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="2"><span style="color: #24292E">  </span><span style="color: #6F42C1">remote</span><span style="color: #24292E">( randomOracleCtcInfo, {</span></li><li value="3"><span style="color: #24292E">    getRandom: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], UInt),</span></li><li value="4"><span style="color: #24292E">  });</span></li><li value="5"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">token</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="6"><span style="color: #24292E">  </span><span style="color: #6F42C1">remote</span><span style="color: #24292E">( tokenCtcInfo, {</span></li><li value="7"><span style="color: #24292E">    balanceOf: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([Address], UInt),</span></li><li value="8"><span style="color: #24292E">    transferTo: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt, Address], Null),</span></li><li value="9"><span style="color: #24292E">  });</span></li></ol></pre>
<p>Once constructed, the fields of a remote object represent those remote contract interactions, referred to as remote functions. For example, randomOracle.getRandom, token.balanceOf, and token.transferTo are remote functions in the example.</p>
<p>A remote function may be invoked by calling it with the appropriate arguments, whereupon it returns the specified output. In addition, a remote function may be augmented with one of the following operations:</p>
<ul>
  <li>
    <p>REMOTE_FUN.pay(AMT) — Returns a remote function that receives a pay amount, AMT, from the caller when it is called.</p>
  </li>
  <li>
    <p>REMOTE_FUN.bill(AMT) — Returns a remote function that provides a pay amount, AMT, to the caller when it returns.</p>
  </li>
  <li>
    <p>REMOTE_FUN.withBill() — Returns a remote function that provides some number of network tokens and, possibly, non-network tokens to the caller when it returns. The exact amount is returned from the invocation by wrapping the original result in a tuple.</p>
    <p>If the remote contract is not expected to return non-network tokens then a pair is returned, where the amount of network tokens received is the first element, and the original result is the second element.</p>
    <p>If the remote contract is expected to return non-network tokens then a triple is returned, where the amount of network tokens received is the first element, a tuple of the non-network tokens received is the second element, and the original result is the third element. If the caller expects to receive non-network tokens, they must provide a tuple of tokens as an argument to withBill. The ordering of tokens in the argument is reserved when returning the amounts received. For example,</p>
    <pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">returned</span><span style="color: #24292E">, [</span><span style="color: #005CC5">gilRecv</span><span style="color: #24292E">, </span><span style="color: #005CC5">zmdRecv</span><span style="color: #24292E">], </span><span style="color: #005CC5">randomValue</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span></li><li value="2"><span style="color: #24292E">  randomOracle.getRandom.</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(stipend).</span><span style="color: #6F42C1">withBill</span><span style="color: #24292E">([gil, zmd])();</span></li></ol></pre>
    <p>might be the way to communicate with a random oracle that receives a conservative approximation of its actual cost and returns what it does not use, along with some amount of GIL and ZMD. This operation may not be used with REMOTE_FUN.bill.</p>
  </li>
</ul>
<h2 id="require">require</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #005CC5">require</span><span style="color: #24292E">( claim, [msg] )</span></li></ol></pre>
<p>A requirement where claim evaluates to true with honest participants. This may only appear in a consensus step. It accepts an optional bytes argument, which is included in any reported violation.</p>
<h2 id="set">Set</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">bidders</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Set</span><span style="color: #24292E">();</span></li><li value="2"><span style="color: #24292E">bidders.</span><span style="color: #6F42C1">insert</span><span style="color: #24292E">(Alice);</span></li><li value="3"><span style="color: #24292E">bidders.</span><span style="color: #6F42C1">remove</span><span style="color: #24292E">(Alice);</span></li><li value="4"><span style="color: #24292E">bidders.</span><span style="color: #6F42C1">member</span><span style="color: #24292E">(Alice); </span><span style="color: #6A737D">// false</span></li></ol></pre>
<p>A Set is another container for linear state. It is simply a type alias of Map(Null); it is only useful for tracking Addresses. Because a Set is internally a Map, it may only be constructed in a consensus step.</p>
<p>A Set may be modified by writing s.insert(ADDRESS) to install ADDRESS in the set, s, or s.remove(ADDRESS) to remove the ADDRESS from the set. Such modifications may only occur in a consensus step.</p>
<p>s.member(ADDRESS) will return a Bool representing whether the address is in the set.</p>
<h2 id="throughtimeout">.throughTimeout</h2>
<h2 id="timeremaining">.timeRemaining</h2>
<h2 id="token">Token</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #005CC5">require</span><span style="color: #24292E">(supply </span><span style="color: #D73A49">&gt;=</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> amt);</span></li><li value="2"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">tok</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Token</span><span style="color: #24292E">({ name, symbol, url, metadata, supply, decimals });</span></li><li value="3"><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(amt, tok).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(who);</span></li><li value="4"><span style="color: #24292E">tok.</span><span style="color: #6F42C1">burn</span><span style="color: #24292E">(amt);</span></li><li value="5"><span style="color: #6F42C1">assert</span><span style="color: #24292E">(tok.</span><span style="color: #6F42C1">supply</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> supply </span><span style="color: #D73A49">-</span><span style="color: #24292E"> amt);</span></li><li value="6"><span style="color: #24292E">tok.</span><span style="color: #6F42C1">burn</span><span style="color: #24292E">();</span></li><li value="7"><span style="color: #6F42C1">assert</span><span style="color: #24292E">(tok.</span><span style="color: #6F42C1">destroyed</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span></li><li value="8"><span style="color: #24292E">tok.</span><span style="color: #6F42C1">destroy</span><span style="color: #24292E">();</span></li></ol></pre>
<p>We refer to creation of a new non-network token as token minting. It is written with the expression new Token(PARAMS), where PARAMS is an object with the following keys:</p>
<ul>
  <li>
    <p><code>name</code>: A value of type Bytes(32); defaults to empty.</p>
  </li>
  <li>
    <p><code>symbol</code>: A value of type Bytes(8); defaults to empty.</p>
  </li>
  <li>
    <p><code>url</code>: A value of type Bytes(96); defaults to empty.</p>
  </li>
  <li>
    <p><code>metadata</code>: A value of type Bytes(32); defaults to empty. This value is intended to be a digest of a larger metadata document.</p>
  </li>
  <li>
    <p><code>supply</code>: A value of type UInt; defaults to UInt.max.</p>
  </li>
  <li>
    <p><code>decimals</code>: A value of type UInt; defaults to 6 on Algorand, and 18 on Ethereum and Conflux.</p>
  </li>
</ul>
<p>This returns a Token value and deposits a supply amount of the new non-network tokens into the contract account associated with the DApp. These tokens must be destroyed by the end of the DApp.</p>
<p>A token has the following methods:</p>
<ul>
  <li>
    <p>Token.burn(tok, amt), or tok.burn(amt), where tok is a Token value and amt is a UInt value, may be used to burn tokens in the contract account, meaning that they are utterly destroyed and can never be recovered.</p>
  </li>
  <li>
    <p>Token.destroy(tok), or tok.destroy(), where tok is a Token value, may be used to destroy the token so that it may never be used again by any users on the consensus network. This must be called before the application exits.</p>
  </li>
  <li>
    <p>Token.destroyed(tok), or tok.destroyed(), where tok is a Token value, returns whether destroy has been called on tok yet.</p>
  </li>
  <li>
    <p>Token.supply(tok), or tok.supply(), where tok is a Token value, may be used to query the current supply of tokens, i.e. the number of tokens which have not been burnt.</p>
  </li>
</ul>
<h2 id="transfer">transfer</h2>
<p>The expression is written like this:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Alice);</span></li><li value="2"><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E">, gil).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Alice);</span></li></ol></pre>
<p>A transfer expression, written transfer(AMOUNT_EXPR).to(ADDR_EXPR), where AMOUNT_EXPR is an expression that evaluates to an unsigned integer, and ADDR_EXPR evaluates to an address, performs a transfer of network tokens from the contract to the named participant. AMOUNT_EXPR must evaluate to less than or equal to the balance of network tokens in the contract account.</p>
<p>A transfer expression may also be written transfer(AMOUNT_EXPR, TOKEN_EXPR).to(ADDR_EXPR), where TOKEN_EXPR is a Token, which transfers non-network tokens of the specified type.</p>
<p>A transfer expression may only occur within a consensus step.</p>
<h2 id="while">while</h2>
<p>A while statement may occur within a consensus step and is written:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #005CC5">LHS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">INIT_EXPR</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #005CC5">DEFINE_BLOCK</span><span style="color: #24292E">; </span><span style="color: #6A737D">// optional</span></li><li value="3"><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #005CC5">INVARIANT_EXPR</span><span style="color: #24292E">);</span></li><li value="4"><span style="color: #D73A49">while</span><span style="color: #24292E">( </span><span style="color: #005CC5">COND_EXPR</span><span style="color: #24292E"> ) </span><span style="color: #005CC5">BLOCK</span></li></ol></pre>
<p>where LHS is a valid left-hand side of an identifier definition where the expression INIT_EXPR is the right-hand side, and DEFINE_BLOCK is an optional block that may define bindings that use the LHS values which are bound inside the rest of the while and its tail, and INVARIANT_EXPR is an expression, called the loop invariant, that must be true before and after every execution of the block BLOCK, and if COND_EXPR is true, then the block executes, and if not, then the loop terminates and control transfers to the continuation of the while statement. The identifiers bound by LHS are bound within DEFINE_BLOCK, INVARIANT_EXPR, COND_EXPR, BLOCK, and the tail of the while statement.</p>
<p>Here is an example:</p>
<pre class="snippet unnumbered"><ol class="snippet"><li value="1"><span style="color: #D73A49">var</span><span style="color: #24292E"> [ heap1, heap2 ] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">21</span><span style="color: #24292E">, </span><span style="color: #005CC5">21</span><span style="color: #24292E"> ];</span></li><li value="2"><span style="color: #24292E">{ </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">sum</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> heap1 </span><span style="color: #D73A49">+</span><span style="color: #24292E"> heap2; }</span></li><li value="3"><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E"> wagerAmount);</span></li><li value="4"><span style="color: #D73A49">while</span><span style="color: #24292E"> ( </span><span style="color: #6F42C1">sum</span><span style="color: #24292E">() </span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ) {</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #D73A49">...</span><span style="color: #24292E">.</span></li><li value="6"><span style="color: #24292E">  [ heap1, heap2 ] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [ heap1 </span><span style="color: #D73A49">-</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">, heap2 ];</span></li><li value="7"><span style="color: #24292E">  </span><span style="color: #D73A49">continue</span><span style="color: #24292E">; }</span></li></ol></pre>